{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-12-05-migrate-from-react-loadable/","result":{"data":{"site":{"siteMetadata":{"title":"Mike Plummer"}},"markdownRemark":{"id":"96baf739-7c19-5411-b427-d6fb25947f26","html":"<blockquote>\n<p><em>This was originally posted at <a href=\"https://objectpartners.com/2018/12/05/migrate-from-react-loadable-to-react-suspense/\">Object Partners</a></em></p>\n</blockquote>\n<p>React apps using code splitting often use the excellent <a href=\"https://github.com/jamiebuilds/react-loadable\">react-loadable</a> library which handles detecting whether a code segment has been loaded and, if not, putting up a spinner or other ‚Äúwait‚Äù indicator while that code is asynchronously fetched from the server. With the release of React v16.6, however, we Javascript developers have a very rare opportunity ‚Äì we can actually remove one of our third-party dependencies!</p>\n<p><a href=\"https://reactjs.org/docs/code-splitting.html\">React.Suspense</a> is a new capability added to the core React library that you get for free which does almost the exact same thing as react-loadable, so without further ado, let‚Äôs look at how to swap them out.</p>\n<h1>Code Splitting?</h1>\n<p>If you aren‚Äôt familiar with this capability, basically it‚Äôs possible to use your code bundler (namely, Webpack) to bundle your code up into multiple chunks. A main chunk will be downloaded when the user loads your app, then as they navigate around additional chunks containing the assets and logic for those sections can be asynchronously loaded on-demand. This is obviously more complicated, but can dramatically improve the initial loading time of your app and also helps out mobile users by using less bandwidth. The good news is that Webpack (and other solutions as well) handle all the complexity here as far as creating the bundles and requesting them when necessary, so all we need to do is incorporate that capability into our app so that users are left with a seamless experience.</p>\n<h1>Step One: Upgrade to React 16.6</h1>\n<p>If you aren‚Äôt already on 16.6 you‚Äôll have to update. If you‚Äôre on an earlier version of v16 then it will likely be a transparent update, but if you‚Äôre coming from v15 you‚Äôll probably need to refer to the React release notes for migration info.</p>\n<h1>Step Two: Identify your async components</h1>\n<p>Most react-loadable uses end up looking something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Loading</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> pastDelay <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pastDelay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Spinner <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> MyAwesomeAsyncComponent <span class=\"token operator\">=</span> <span class=\"token function\">Loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">loader</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"myAwesomeComponent\" */</span> <span class=\"token string\">'./myAwesome.component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">loading</span><span class=\"token operator\">:</span> Loading<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">delay</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this block we‚Äôre doing a few things:</p>\n<ul>\n<li>We define a component to display between the time the component is requested and when it is loaded and ready for render.</li>\n<li>We define a Loadable component, which has a couple pieces to it:\n<ol>\n<li>The ‚Äòloader‚Äô function uses a dynamic import to specify the code location to request. Webpack takes care of the magic here, so all we need to know is that a bundle with the specified resource will be loaded over the network when this function is requested. The special comment is a hint to webpack to give that file a meaningful name.</li>\n<li>The ‚Äòloading‚Äô parameter is a component to display during that request/response cycle ‚Äì here we provide our custom Loading component.</li>\n<li>In this instance we‚Äôre defining a delay ‚Äì we only want to display the Spinner if the loading takes longer than 200 milliseconds. This is to avoid ‚Äúflashing‚Äù the loading in and out if the request completes very quickly.</li>\n</ol>\n</li>\n</ul>\n<p>That‚Äôs it. The component itself will be bundled separately and only loaded over the network once an attempt is made to render it.</p>\n<h1>Step Three: Convert to Suspense</h1>\n<p>Converting to React.Suspense is actually pretty easy.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> MyAwesomeComponent <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"myAwesomeComponent\" */</span> <span class=\"token string\">'./myAwesome.component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">MyAwesomeAsyncComponent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">props</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>React<span class=\"token punctuation\">.</span>Suspense fallback<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">&lt;</span>Spinner <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>MyAwesomeComponent <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>React<span class=\"token punctuation\">.</span>Suspense<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol>\n<li>We use React.lazy to encapsulate the dynamic import, similar to the ‚Äòloading‚Äô parameter in the first example.</li>\n<li>We define a React.Suspense component with a set of ‚Äòfallback‚Äô JSX to render while we await the asynchronous loading. Typically this will be a spinner or other wait indicator.</li>\n<li>We define the JSX we want to render as children ‚Äì this uses the React.lazy-wrapped component reference.</li>\n</ol>\n<p>Ta-Da! This will do the exact same thing as our first example with one notable exception ‚Äì React.Suspense does not have built-in support for a delay, so the fallback JSX will render immediately even if the loading process only takes a few milliseconds. You can work around this by creating custom logic in your fallback component so that it starts a timer in componentDidMount that causes it to not render until a future time.</p>\n<h1>Step Four: What if something goes wrong?</h1>\n<p>What happens if the code chunk fails to load, or some other error condition occurs?</p>\n<h2>react-loadable</h2>\n<p>The library has built-in support for handling loading errors.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Loading</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>Error<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>pastDelay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>Loading<span class=\"token operator\">...</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Suspense</h2>\n<p>React 16 added a new capability known as an <a href=\"https://reactjs.org/docs/error-boundaries.html\">Error Boundary</a>. This is just an error-aware component that is capable of catching and handling errors from its children. To handle issues with async loading we can simply define a custom ErrorBoundary component and wrap our usage of async components within them.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span>MyCustomErrorBoundary<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>MyAwesomeAsyncComponent <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>MyCustomErrorBoundary<span class=\"token operator\">></span></code></pre></div>\n<h1>Last step</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">yarn remove react-loadable</code></pre></div>\n<p>üéâ</p>\n<h1>What‚Äôs the benefit?</h1>\n<p>Obviously we always have to balance the value of ‚Äúit works just fine the way it is‚Äù when we consider upgrades or refactors. So, is this a worthwhile upgrade?</p>\n<p><strong>Bundle savings:</strong> react-loadable is about 2KB once gzipped. Removing this library is not going to have massive impacts on your build time or bundle size, but then again, 2KB is a measurable decrease.</p>\n<p><strong>Fewer dependencies:</strong> JS apps have <em>so many dependencies</em>. Each one is a separate set of documentation, updates, and API‚Äôs you have to manage. More importantly, each one is an additional attack surface for a potentially malicious actor.</p>\n<p><strong>Maintainability:</strong> Sticking to the core React library when possible usually means you‚Äôll get easier integration and fewer maintenance headaches.</p>\n<p><strong>Bragging rights:</strong> Let‚Äôs be honest ‚Äì it‚Äôs cool to be using the latest features.</p>\n<p><strong>Testing:</strong> One huge downside at the moment is that <a href=\"https://airbnb.io/enzyme/\">Enzyme</a> is not Suspense-aware, so unit testing these async components may be tricky until that support is added. (<a href=\"https://github.com/airbnb/enzyme/issues/1553\">This issue</a> is tracking progress)</p>\n<p>#Conclusion\nI‚Äôm not going to claim that this is a must-change capability, but all things considered the functionality is almost identical, the impact is targeted and easily-tested, and the code changes are relatively simple and require no significant refactors. I was able to swap out about 20 async components in about an hour, and 45 minutes of that was figuring out why my Enzyme tests wouldn‚Äôt work. Questions, comments, concerns? Let me know in the comments, otherwise happy coding!</p>","frontmatter":{"title":"Migrate from react-loadable to React.Suspense","date":"December 05, 2018"}}},"pageContext":{"slug":"/2018-12-05-migrate-from-react-loadable/"}},"staticQueryHashes":[]}