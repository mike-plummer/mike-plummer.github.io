{"data":{"site":{"siteMetadata":{"title":"Mike Plummer","author":"Mike Plummer"}},"markdownRemark":{"id":"15320a66-0de6-53eb-b26f-c169c965c686","html":"<blockquote>\n<p><em>This was originally posted at <a href=\"https://objectpartners.com/2015/06/10/websockets-in-grails-3-0/\">Object Partners</a></em></p>\n</blockquote>\n<p>For those who aren’t familiar, WebSockets are a long-lived, interactive, two-way channel between a client browser and end server that allows ongoing communication without polling. They’ve been around for a few years now ever since being proposed by <a href=\"https://tools.ietf.org/html/rfc6455\">RFC 6455</a> and pretty much all of the major browsers have gained support since then. <a href=\"https://spring.io/\">Spring</a>, the ever-popular Java MVC framework, gained built-in WebSocket support in version 4.0 and that support has since been incorporated into <a href=\"http://projects.spring.io/spring-boot/\">Spring Boot</a> and <a href=\"https://grails.org/\">Grails</a> (Grails support is supplied by this <a href=\"https://github.com/zyro23/grails-spring-websocket\">helpful plugin</a>). This article is a high level overview of some tinkering I did to familiarize myself with WebSockets while also learning about the relatively-recent shakeup of Grails as it advanced to 3.0.</p>\n<h2>The Setup</h2>\n<p>Specifically, my use case was to examine ways to avoid manual server polling when sending data back and forth between a server and 1-n clients. For this I decided to use WebSockets managed by <a href=\"https://github.com/sockjs/sockjs-client\">SockJS</a>, a library that handles the nitty-gritty of establishing and maintaining those connections, and <a href=\"http://jmesnil.net/stomp-websocket/doc/\">Stomp</a>, a messaging protocol built for WebSockets. Being a developer with lots of Java experience, my initial reaction to this stack was “it’s JMS, but better”. Those who have worked with Java Message Service probably know what I’m referring to – JMS allows reliable, highly-customizable cross-system messaging but can be heavy, hard to configure, and definitely doesn’t have any graceful integration into the sort of web applications being developed these days. This stack supplies many of the same capabilities while being simpler, lighter-weight, and downright simple to integrate:</p>\n<ol>\n<li>Pub/Sub Model – messages are published to customizable endpoints (think of them as mailboxes), interested clients can subscribe/unsubscribe at-will</li>\n<li>Topics and Queues – determine how and to whom messages get delivered: broadcast, first-come, or targeted consumer</li>\n<li>Delivery Acknowledgement and Transactions – bundle sets of messages to guarantee an entire batch gets worked or rolled back in case of error</li>\n<li>Filtering – clients can specify what types of messages they wish to receive or ignore</li>\n<li>Security – integrates with Spring Security and readily supports common tools like CSRF tokens</li>\n</ol>\n<h2>The Application</h2>\n<p>For this example I decided to setup a very simple test application. This application would generate (fake) stock quotes at a relatively high frequency, high enough that it would become burdensome to have clients poll often enough to keep up. On top of showcasing this poll-less approach I also wanted to look into the ability to allow clients to interact and decided to go for the tried-and-true chat room use case.</p>\n<p>All the code for this example is available out on <a href=\"https://github.com/mike-plummer/Grails_WebSockets\">GitHub</a> so I will just be highlighting the most important functional bits here. First up is the code that generates data for my faux stock ticker – this code runs in the background on the server pushing new quotes out to a Stomp topic that clients can subscribe to.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token comment\">/**\n * Quartz job that kicks off at Grails startup. This job executes every 2.5\n * seconds to generate a fake stock quote, convert it to JSON, and publish\n * it to the optionally-subscribed-to stockQuote topic. Any browser clients\n * subscribed to the topic will receive it.\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">StockQuoteJob</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * Tell Quartz how to schedule this job. You can optionally define\n     * an initial delay, number of executions, or repeatDelay (as opposed\n     * to repeatInterval).\n     */</span>\n    <span class=\"token keyword\">static</span> triggers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        simple repeatInterval<span class=\"token punctuation\">:</span> <span class=\"token number\">2500L</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * Inject the messenger that accepts Stomp messages.\n     */</span>\n    SimpMessagingTemplate brokerMessagingTemplate\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/**\n         * Use the awesome Groovy JsonBuilder to convert a dynamically-defined\n         * data structure to JSON.\n         */</span>\n        <span class=\"token keyword\">def</span> builder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JsonBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        builder <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">symbol</span><span class=\"token punctuation\">(</span>generatedSymbol<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">price</span><span class=\"token punctuation\">(</span>random<span class=\"token operator\">.</span><span class=\"token function\">nextDouble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">timestamp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">//Publish the new quote</span>\n        brokerMessagingTemplate<span class=\"token operator\">.</span>convertAndSend <span class=\"token string gstring\">\"/topic/stockQuote\"</span><span class=\"token punctuation\">,</span> builder<span class=\"token operator\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, we need some more server-side code to arbitrate chat messages – effectively, this code reflects any incoming messages out to all listeners.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ChatController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * Accepts incoming chat messages sent by browsers and routes them\n     * to the 'chat' topic that all browser clients are subscribed to.\n     */</span>\n    <span class=\"token annotation punctuation\">@MessageMapping</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"/chat\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@SendTo</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"/topic/chat\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">protected</span> String <span class=\"token function\">chat</span><span class=\"token punctuation\">(</span>String chatMsg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/**\n         * Use the awesome Groovy JsonBuilder to convert a dynamically-defined\n         * data structure to JSON.\n         */</span>\n        <span class=\"token keyword\">def</span> builder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JsonBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        builder <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">message</span><span class=\"token punctuation\">(</span>chatMsg<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">timestamp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        builder<span class=\"token operator\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that all the server code is in place, we create a basic webpage. The code below provides the ability for the user to subscribe and unsubscribe to stock quotes, send chat messages, and receive messages sent by other users.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">defer</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\">\n    <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//Create a new SockJS socket - this is what connects to the server using a WebSocket</span>\n        <span class=\"token keyword\">var</span> socket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SockJS</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${createLink(uri: '/stomp')}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//Build a Stomp client to send messages over the socket we built.</span>\n        <span class=\"token keyword\">var</span> client <span class=\"token operator\">=</span> Stomp<span class=\"token punctuation\">.</span><span class=\"token function\">over</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//Track the subscription so we can unsubscribe later.</span>\n        <span class=\"token keyword\">var</span> quoteSubscription<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//Have SockJS connect to the server.</span>\n        client<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//Subscribe to the 'chat' topic and define a function that is executed</span>\n            <span class=\"token comment\">//anytime a message is published to that topic by the server or another client.</span>\n            client<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/topic/chat\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">var</span> chatMsg <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n                <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#chatDiv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>chatMsg<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleTimeString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">': '</span> <span class=\"token operator\">+</span> chatMsg<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//When the user clicks the 'subscribe' button...</span>\n        <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#startButton\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//Initiate a subscription to stockQuote messages.</span>\n            quoteSubscription <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/topic/stockQuote\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">var</span> quote <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#symbol\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span>symbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#price\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#timestamp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//When the user clicks the 'unsubscribe' button...</span>\n        <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#stopButton\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//Unsubscribe so we don't get any more messages</span>\n            quoteSubscription<span class=\"token punctuation\">.</span><span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//When the user sends a chat message publish it to the chat topic</span>\n        <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#sendButton\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/app/chat\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#chatMessage\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">val</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Put it all together and launch as a Grails application and you get something like you see below. You can open any number of browser tabs and they will all receive the same stock quote data at the same time (provided they each subscribe) and they all can participate in a shared chat. The best part? No background AJAX requests barraging the server for the latest data.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-d9514.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAByUlEQVQoz6XS22sTQRTA4fkjBVFB8MEWn6SCNWIgPvQlVGqLilpKtTaKotWKza2JaxpjY9RILpukrZeaRN2VpAbpxtzzczZt2lJsDDjw7TJnZw9nzox4cO8OgeeL+L1OXvg8XLKPYDl7mvPDQ1ywnMHap4vWYfnfECIYWsYVivFMibCgvMYVfIc3FO14qrzhkS/CnP/fHsp18y4/Yuz2PJZby5ybfoltNox1NoLNEWHk/lsGrgY4bPdxdNTPkR6OSYfsCrbrc4hw+BW6rpHLZdE1jf8ZqppARN9HMYwKxeIGhUKBVqtFu93uvE3NrubBGo1mJ2E8EUckkgmKGzUZbMlQezfhHvvn+zWbWwnVlIpIpVOUy5uUSqWOer2+U12/ugnTmTQiKSusVKqywsbOR5M53+tvsS6zCHOsrGQQsXgMTdcxyr/ZNAyqtTqValVuhS3y0TD71EN9u4drH9YQuS+fKP3I8/XzKj/1PL+KGsXvWagZMltFtrXa9yl/y68jzEt9bUHlhivJlDfDpCfNTbfKtG+VGeVjh2NpHUfwYHelmaUszpA85aknAU6MeTh1ZZHBCe+ucQ8D205edvc0OO7m+KiTyccB/gCm30DsE3W4XAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"grails websocket screenshot\"\n        title=\"\"\n        src=\"/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-fb8a0.png\"\n        srcset=\"/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-1a291.png 148w,\n/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-2bc4a.png 295w,\n/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-fb8a0.png 590w,\n/static/grails-websocket-screenshot-98b5cd60ad049da76b5a90652f9547da-d9514.png 600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>Wrap Up</h2>\n<p>Once you take out all the fluff, we were just able to put together a neat little app that handles some non-trivial interactions in just a few dozen lines of code. Of course, this is hardly a complex example of WebSockets or Grails but hopefully it has shown you a quick way to simplify a common use case using some neat tools. Take a look at the source out on <a href=\"https://github.com/mike-plummer/Grails_WebSockets\">GitHub</a>, and happy coding!</p>","frontmatter":{"title":"WebSockets in Grails 3.0","date":"June 10, 2015"}}},"pageContext":{"slug":"/2015-06-10-websockets-in-grails-3-0/"}}