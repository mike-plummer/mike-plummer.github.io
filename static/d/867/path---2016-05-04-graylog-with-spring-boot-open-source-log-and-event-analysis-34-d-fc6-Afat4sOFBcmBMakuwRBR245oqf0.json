{"data":{"site":{"siteMetadata":{"title":"Mike Plummer","author":"Mike Plummer"}},"markdownRemark":{"id":"bca8018b-ede7-5d8c-996e-f8f43addf084","html":"<blockquote>\n<p><em>This was originally posted at <a href=\"https://objectpartners.com/2016/05/04/graylog-with-spring-boot-open-source-log-and-event-analysis/\">Object Partners</a></em></p>\n</blockquote>\n<p>One of the most difficult things to do in any application is find a way to make use of the mountains of logs that are generated, especially in a Production environment. Over the years a number of tools have emerged to tackle this problem. Designed as massive data stores and analysis engines, tools like <a href=\"http://www.splunk.com/\">Splunk</a> allow you to collate and process logs from a vast array of sources and manipulate the data they contain into usable alerts, dashboards, and automated actions.</p>\n<p>I’m a huge fan of Splunk and have seen it used to great effect in large-scale deployments. It’s user friendly and extremely powerful, but has a huge downside: price. This makes it unattractive for small projects and impractical for personal/hobby development. But all is not lost – <a href=\"http://www.graylog.org/\">Graylog</a> is an open-source, free-to-use alternative that has has many of the top features supplied by Splunk. In this article I’ll talk about how I familiarized myself with the basics of Graylog’s recently released version 2 and show off an example SpringBoot app that uses it.</p>\n<h1>What is it?</h1>\n<p>The simplest way to describe Graylog is as an event archive and analysis toolkit. The basic idea is that you publish events that happen inside your application and Graylog stores them into a MongoDB instance. Later, these events can be searched via an ElasticSearch cluster and then combined to generate trends, charts, tables, and other views of that data.</p>\n<h1>How does data get to it?</h1>\n<p>A lot of different mechanisms exist. In the example application I show off HTTP and UDP endpoints that accept GELF (Graylog Extended Log Format) data, but you can also configure ways to send plaintext or even hook up your OS’s syslog. The real magic comes in how you can interface those endpoints into your application. One of the most powerful is to hook into your existing logging solution which gives it access to all significant events that you’re already capturing (most notably errors) and then dispatch them in the background to Graylog; this approach allows you to transparently add Graylog to your application without tightly coupling your code to it.</p>\n<h1>How do I use it once data is there?</h1>\n<p>At it’s core Graylog is a facade over an ElasticSearch cluster backed by MongoDB. Dynamic queries can be written to find any permutation of event data. From a user interface perspective, most of the focus is on Dashboards. A Dashboard is a collection of widgets, each of which is a chart/table/trend backed by a query. By crafting queries and widgets you can keep track of ongoing events in your application, keep an eye on performance and system load, monitor suspicious events, or track down details on an error one of your users encountered.</p>\n<h1>You mentioned an example app?</h1>\n<p>Out on <a href=\"https://www.github.com/mike-plummer/graylog-springboot\">GitHub</a> there is a SpringBoot application that fires up a (as much as possible) self-contained Graylog instance, configures it, and publishes events to it. I say ‘as much as possible’ for the following reasons:</p>\n<ol>\n<li>There is no pure-Java MongoDB: I’ve configured an embedded Mongo provider to download binaries at runtime in a way that doesn’t pollute your computer.</li>\n<li>Graylog is intended to run as a standalone process – it ships with a control script to launch it within its own JVM instance. I’ve created the necessary Spring configs and beans to get it to launch within the SpringBoot JVM but this comes with its own limitations (namely memory and classpath separation) which may make this configuration impractical for other setups.</li>\n</ol>\n<p>When the application starts it launches an ElasticSearch node, downloads and launches MongoDB, and initializes the Graylog instance. Once those are all up and running it makes a number of ReST calls to the Graylog service interface to establish a basic configuration and a customized dashboard.</p>\n<h2>Maven</h2>\n<p>Normally I prefer to use Gradle but in this case I needed to use the perfectly-capable Maven to handle dependencies. Some of Graylog’s dependencies have malformed POM files which Gradle does not handle as gracefully as Maven.</p>\n<p>The Maven build, other than handling the download of dependencies, also takes care of some minor setup by extracting a ZIP archive containing some native libraries needed by Graylog – more on these a bit later.</p>\n<h2>Spring Boot</h2>\n<p>The only major tweak I had to make related to SpringBoot was to use a Milestone version of the as-yet-unreleased version 1.4.0. This was primarily to get the benefit of it upgrading to a newer version of ElasticSearch that is compatible with Graylog. Other than that all of the Spring code should be pretty familiar to most Java developers.</p>\n<p>One item that may be of interest is that I’ve set up a Swagger Rest API for my application (in addition to the one Graylog supplies) that allows you to view and exercise the very simple Rest service the app provides. It uses a library called <a href=\"https://springfox.github.io/springfox/\">SpringFox</a> which I highly recommend taking a look at if you develop Rest services in Spring.</p>\n<h2>MongoDB</h2>\n<p>I’ve chosen to use an excellent <a href=\"https://github.com/flapdoodle-oss/de.flapdoodle.embed.mongo\">embedded MongoDB library</a> and configure it using a Singleton Spring bean. Most of this configuration isn’t strictly necessary but helps in keeping all the files that get downloaded in a single place so they get deleted once you’re done with the example.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// Download Mongo artifacts into the project directory to ease cleanup</span>\n    IDownloadConfig downloadConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DownloadConfigBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">defaultsForCommand</span><span class=\"token punctuation\">(</span>Command<span class=\"token punctuation\">.</span>MongoD<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">artifactStorePath</span><span class=\"token punctuation\">(</span>ARTIFACT_STORE_PATH<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Extract Mongo artifacts into the project directory to ease cleanup</span>\n    IRuntimeConfig runtimeConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeConfigBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">defaults</span><span class=\"token punctuation\">(</span>Command<span class=\"token punctuation\">.</span>MongoD<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">artifactStore</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ExtractedArtifactStoreBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">defaults</span><span class=\"token punctuation\">(</span>Command<span class=\"token punctuation\">.</span>MongoD<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">download</span><span class=\"token punctuation\">(</span>downloadConfig<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">extractDir</span><span class=\"token punctuation\">(</span>EXTRACTED_STORE_PATH<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Store Mongo data into the project directory to ease cleanup</span>\n    Storage replication <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Storage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./data/mongodb/data\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    MongodStarter starter <span class=\"token operator\">=</span> MongodStarter<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>runtimeConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    IMongodConfig mongodConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MongodConfigBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">version</span><span class=\"token punctuation\">(</span>Version<span class=\"token punctuation\">.</span>Main<span class=\"token punctuation\">.</span>PRODUCTION<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">cmdOptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">MongoCmdOptionsBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">useNoJournal</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">useSmallFiles</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">net</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Net</span><span class=\"token punctuation\">(</span>MongoProperties<span class=\"token punctuation\">.</span>DEFAULT_PORT<span class=\"token punctuation\">,</span> Network<span class=\"token punctuation\">.</span><span class=\"token function\">localhostIsIPv6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replication</span><span class=\"token punctuation\">(</span>replication<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    mongo <span class=\"token operator\">=</span> starter<span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span>mongodConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    process <span class=\"token operator\">=</span> mongo<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This starts up a Mongo instance that can be interacted with as if it were a standalone instance. When the SpringBoot app stops it stops as well.</p>\n<h2>ElasticSearch</h2>\n<p>Nothing is needed to get ElasticSearch up and running other than including the <code class=\"language-text\">spring-boot-starter-data-elasticsearch</code> dependency in the project’s build file. SpringBoot auto-detects its presence on the classpath and starts up the ElasticSearch node. A bit of configuration is necessary in the application config file to get the appropriate type of node set up so that Graylog can work with it:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">elasticsearch</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">clusterName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"graylog\"</span>\n      <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">local</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n          <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<h2>Graylog</h2>\n<p>This is the trickiest part – Graylog is a Java application but its API isn’t really designed to be started as part of another program. The first trick is to extract as much as possible from Graylog’s normal boot path and embed it in a Singleton bean, and the easiest way to make this work is to piggyback on Graylog’s built-in launcher that expects to be triggered from the command line.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">// Use the CommandLine launch parser which takes care of triggering all the sub-modules</span>\n    <span class=\"token comment\">// Graylog needs to launch.</span>\n    <span class=\"token keyword\">final</span> Cli<span class=\"token punctuation\">.</span>CliBuilder builder <span class=\"token operator\">=</span> Cli<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"graylog\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withDefaultCommand</span><span class=\"token punctuation\">(</span>Help<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withCommands</span><span class=\"token punctuation\">(</span>Help<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> ShowVersion<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ServiceLoader commandsProviders <span class=\"token operator\">=</span> ServiceLoader<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>CliCommandsProvider<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Load all Graylog command handlers so we can process the CLI command</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Object commandsProvider <span class=\"token operator\">:</span> commandsProviders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        CliCommandsProvider command <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CliCommandsProvider<span class=\"token punctuation\">)</span> commandsProvider<span class=\"token punctuation\">;</span>\n        command<span class=\"token punctuation\">.</span><span class=\"token function\">addTopLevelCommandsOrGroups</span><span class=\"token punctuation\">(</span>builder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">final</span> Cli cli <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Run the actual CLI command through the parser</span>\n    <span class=\"token keyword\">final</span> Runnable command <span class=\"token operator\">=</span> cli<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-f\"</span><span class=\"token punctuation\">,</span> graylogConfigFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Build the command (which is a Runnable) and start into another Thread - necessary</span>\n    <span class=\"token comment\">// since the runnable blocks on the Graylog server process</span>\n    <span class=\"token keyword\">final</span> Thread graylogThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    graylogThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next, I had to configure the SIGAR library – this is a set of native libraries that Graylog accesses via JNI so it has to be put onto the special Java library path. In case you aren’t familiar with JNI this library path is very different than the standard Java classpath. For more information on JNI take a look at <a href=\"https://objectpartners.com/2015/04/21/interfacing-groovy-and-java-with-native-libraries/\">my post on the subject</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    System<span class=\"token punctuation\">.</span><span class=\"token function\">setProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"java.library.path\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./sigar-libs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The last thing I had to do was the only really tricky part. Fortunately, Graylog supplies a live <a href=\"http://swagger.io/\">Swagger specification</a> for its ReST API, but unfortunately it’s configured to use the System classloader rather than the Thread Context classloader. This causes issues when run within a container like SpringBoot. To work around this problem I had to use some very inadvisable Reflection to swap out the System classloader with a custom one that would delegate to the Thread Context when a Swagger resource was being loaded. I’ll be submitting a PR to Graylog to hopefully resolve this issue in the near future.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        Field sclField <span class=\"token operator\">=</span> ReflectionUtils<span class=\"token punctuation\">.</span><span class=\"token function\">findField</span><span class=\"token punctuation\">(</span>ClassLoader<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"scl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ReflectionUtils<span class=\"token punctuation\">.</span><span class=\"token function\">makeAccessible</span><span class=\"token punctuation\">(</span>sclField<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ReflectionUtils<span class=\"token punctuation\">.</span><span class=\"token function\">setField</span><span class=\"token punctuation\">(</span>sclField<span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DecoratingClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> URL <span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span>String name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"swagger/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContextClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        LOGGER<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to replace SystemClassLoader, this means Graylog's Swagger won't work.\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Graylog works just fine without doing this, but for this example I wanted to make sure the documentation was functional.</p>\n<h2>Publishing data to Graylog</h2>\n<p>Now that we have Graylog configured we need to start pushing data to it. I set up two different paths: a UDP interface that publishes anything sent to a specific Logback logger, and a ReST endpoint. To use these I set up one Aspect that captures calls to a specific service and another that captures errors thrown by that service.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Inject</span>\n    <span class=\"token keyword\">protected</span> ObjectMapper mapper<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Inject</span>\n    <span class=\"token keyword\">protected</span> GraylogRestInterface graylog<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Around</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"execution(* com.objectpartners.plummer.graylog.service.QuoteService.*(..))\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> QuoteResource <span class=\"token function\">errorThrown</span><span class=\"token punctuation\">(</span>ProceedingJoinPoint joinPoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Throwable <span class=\"token punctuation\">{</span>\n        Stopwatch timer <span class=\"token operator\">=</span> Stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">createStarted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        QuoteResource quote <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>QuoteResource<span class=\"token punctuation\">)</span> joinPoint<span class=\"token punctuation\">.</span><span class=\"token function\">proceed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Log message via Graylog UDP Logback Appender</span>\n        LOGGER<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Generated quote - {}@{}\"</span><span class=\"token punctuation\">,</span> quote<span class=\"token punctuation\">.</span><span class=\"token function\">getSymbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Log message via Graylog HTTP Input</span>\n        GelfMessage message <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GelfMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setShortMessage</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Quote %s@%2.2f\"</span><span class=\"token punctuation\">,</span> quote<span class=\"token punctuation\">.</span><span class=\"token function\">getSymbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote<span class=\"token punctuation\">.</span><span class=\"token function\">getPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setFullMessage</span><span class=\"token punctuation\">(</span>mapper<span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">getAdditionalProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"elapsed_time\"</span><span class=\"token punctuation\">,</span> timer<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">elapsed</span><span class=\"token punctuation\">(</span>TimeUnit<span class=\"token punctuation\">.</span>MICROSECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        graylog<span class=\"token punctuation\">.</span><span class=\"token function\">logEvent</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> quote<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h1>Graylog in Action</h1>\n<p>So, after all this heavy lifting what is the end result?</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-02305.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 69.72049689440993%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVQ4y5VTy27TQBT117DqzyCSEEiT9BMQf8KSLRKiqBQJCl10DQuohNQFqSCtmiZugtrEzxnb40cO545r1FYsYKSjO56Z+zjnXjuDfh/DTgedThuDwcBia2uIXq+HPu+63S5arRba7fYt3H/QQvdxD4PhFh52H2Fzk/tBH858MYd74WI+nyNJNLIsQ16UWK/XFn9bganw4VRj70Th/Vjh42mAbxdvcLI8gOO6LpbLJYLAh+et4PkB/EgjjmMYY2yCBmmaWquTFL4SJLWNNSLtIdY+nMD3EQYhA6Z8mKDIKygVw+f5asUEnmchCRLeh2Fov0MWkGgyShMLrRO+UXAMM64rwL16jsmnZwiXM0tLK4WiKCzt0WiEw8PDPzJIYllS8ej4GNNZ7SN3TllyAx9H4w18+bqBn7OndUBdB5Ql1MW5qiqYNCMDZZ1LOosEJs/tXZ4ZOPJQqvk+foLPR/fgLl7DZEAUBZQhoI0s3ZhvhLKS/TV9gfinQpn3EeVwfozHeLG9i1e7e3i5s4Ptt/t4t3+AKzZKdIzoHCkNxUaYklVYrK8tUdQ2YXUpmThhRIEZ3fCRzgp2OEbGsVEMIlR5jIr0hJLYnDI0KHkmaLTOSd1J2HLD6JSbB8bOoqz4BjXNbopuYoWa3TffFvU+9Dg2XhDjMkwQpAWWcYpfPilmJefRx9nZGabTKc7Pz2/ZBvJ9985RdjxKS8eY3FK1f0MYYDKZYMaR+GdMZ3WXK7a/utbCkPaaInsrz2b9r4CEI//wYrG4jfnCli+Upcq7aBI11G8G/A3C+v5m52A5hgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"graylog dashboard\"\n        title=\"\"\n        src=\"/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-fb8a0.png\"\n        srcset=\"/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-1a291.png 148w,\n/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-2bc4a.png 295w,\n/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-fb8a0.png 590w,\n/gatsby-site/static/graylog_dashboard-d0e7105d3634b59a8e21e5433dbe750d-02305.png 644w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>The image above is of the customized dashboard the example sets up. This is a fairly simple example but you can see four different widgets each showing off a different method of tracking and displaying data to the user.</p>\n<ul>\n<li>Quote count: Counts the total number of Quote objects the SpringBoot app has generated</li>\n<li>Symbol Breakdown: Tracks the unique stock symbols that have been requested, broken down by most common</li>\n<li>Generation time: Tracks the average time it took to generate quotes over time</li>\n<li>Errors: All exceptions that are logged get displayed here for easy perusal</li>\n<li>Dashboards are built from ElasticSearch queries that can be easily constructed using the Graylog web GUI.</li>\n</ul>\n<p>Every message that is sent to Graylog is stored into MongoDB and can be inspected and queried which aids debugging and troubleshooting in the future. Assuming you send the appropriate data into Graylog this means you may never have to dig through application logs again. Below you can see an example of an archived event in Graylog which was automatically parsed from JSON and put into an easy-to-read and easy-to-search format.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-5a4be.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 49.141630901287556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8ElEQVQoz6WSi27CMAxF8/9fOSjbIO++0yrJJQ4UpQExoVm6atTWx9d2WPNzxvH7Ai4k1nVF3/fQWsM5h2VZQBFjRAjhpepv7OtwgEgway1MAhGMc47TqYGQMgND8FBKwRiTpZOkkilP5P/pHc9nAyaUhtQWo1sQcYuu6zCO48PdO4el2rYF+70IcGXgVo8Qb0gpRapqd8Dy/EoUloA0N6JvCRRUidqgOc7znJ/TNGXX5VxrZYf3LneVtpa9929dPQFTHqtboiB3tG1/3+JHQBSxAWlz9VL+BVTpSgzDgHocfwLLGZbAfCdT27QA0ifAKwlEEHMCs+AVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"gelf message\"\n        title=\"\"\n        src=\"/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-fb8a0.png\"\n        srcset=\"/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-1a291.png 148w,\n/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-2bc4a.png 295w,\n/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-fb8a0.png 590w,\n/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-526de.png 885w,\n/gatsby-site/static/gelf_message-4fe2f0d97629351ac21e6cf2d2e49a1b-5a4be.png 932w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1>What would it take to use Graylog in my project?</h1>\n<p>For the purposes of the example I’m doing a lot that you shouldn’t do in a production application. If all you need is a prototyping setup or a ready-to-go development configuration the example can be used to get up and running quickly. Beyond that, Graylog has a ready-to-go <a href=\"https://github.com/Graylog2/graylog2-images\">Docker image</a> that you can easily combine with the <a href=\"https://hub.docker.com/r/library/mongo/\">Mongo</a> and <a href=\"https://hub.docker.com/_/elasticsearch/\">ElasticSearch</a> images for a more stable and realistic Graylog setup if that is desired. In a true production environment it would be advisable to use a standalone MongoDB instance for better performance as well as a true ElasticSearch cluster to aid distributed processing and storage.</p>\n<h1>Wrap Up</h1>\n<p>If Graylog sounds interesting to you I highly recommend taking a look. They’ve got excellent documentation and adding it to your application will definitely make your life easier in the future. If you have any questions about the <a href=\"https://github.com/mike-plummer/graylog-springboot\">example application</a> or the article please leave them below. Otherwise, happy coding!</p>","frontmatter":{"title":"Graylog with Spring Boot","date":"May 04, 2016"}}},"pageContext":{"slug":"/2016-05-04-graylog-with-spring-boot-open-source-log-and-event-analysis/"}}